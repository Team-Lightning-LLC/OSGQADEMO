<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSG QA Demo</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Serif:wght@400;500&display=swap');
    
    :root {
      --bg: #f5f1ea;
      --surface: #fdfaf4;
      --surface-hover: #faf7f0;
      --text: #3d3830;
      --text-2: #6a6259;
      --text-3: #a09686;
      --border: #e5ddd0;
      --border-soft: #ede6db;
      
      --pass: #5a8a6a;
      --pass-soft: #f0f5ef;
      --pass-glow: rgba(90, 138, 106, 0.08);
      
      --fail: #c4785c;
      --fail-soft: #faf2ed;
      --fail-glow: rgba(196, 120, 92, 0.08);
      
      --gap: #9a9488;
      --gap-soft: #f4f2ed;
      
      --accent: #5a7a8a;
      --accent-soft: #eef2f4;
      
      --grain: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      --grain-opacity: 0.025;
      --surface-glow: linear-gradient(165deg, rgba(253,250,244,0.6) 0%, rgba(245,241,234,0.3) 100%);
      --card-shadow: 0 1px 2px rgba(60, 50, 40, 0.03), 0 4px 12px rgba(60, 50, 40, 0.04);
      --card-shadow-hover: 0 2px 4px rgba(60, 50, 40, 0.04), 0 8px 24px rgba(60, 50, 40, 0.06);
    }
    
    [data-mode="moonlit"] {
      --bg: #1a1d24;
      --surface: #232730;
      --surface-hover: #2a2e38;
      --text: #d4d7e0;
      --text-2: #9ba1b0;
      --text-3: #6b7280;
      --border: #363b47;
      --border-soft: #2d313b;
      
      --pass: #6aab8c;
      --pass-soft: rgba(106, 171, 140, 0.12);
      --pass-glow: rgba(106, 171, 140, 0.08);
      
      --fail: #d4856f;
      --fail-soft: rgba(212, 133, 111, 0.12);
      --fail-glow: rgba(212, 133, 111, 0.08);
      
      --gap: #8890a0;
      --gap-soft: rgba(136, 144, 160, 0.12);
      
      --accent: #7a9aaa;
      --accent-soft: rgba(122, 154, 170, 0.12);
      
      --grain-opacity: 0.018;
      --surface-glow: linear-gradient(165deg, rgba(45,50,60,0.4) 0%, rgba(26,29,36,0.2) 100%);
      --card-shadow: 0 1px 2px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.15);
      --card-shadow-hover: 0 2px 4px rgba(0, 0, 0, 0.15), 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'IBM Plex Sans', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      letter-spacing: 0.01em;
      transition: background-color 0.5s ease, color 0.5s ease;
      font-size: 13px;
    }
    
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: var(--grain);
      opacity: var(--grain-opacity);
      pointer-events: none;
      z-index: 1000;
    }
    
    .header {
      background: var(--surface);
      background-image: var(--surface-glow);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.5s ease;
    }
    
    .logo-section { display: flex; align-items: center; gap: 12px; }
    
    .logo {
      width: 32px; height: 32px;
      background: var(--text);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: var(--bg);
      font-weight: 700; font-size: 10px;
    }
    
    .brand-name {
      font-family: 'IBM Plex Serif', Georgia, serif;
      font-size: 15px; font-weight: 500;
    }
    
    .brand-sub { font-size: 11px; color: var(--text-3); }
    
    .header-actions { display: flex; align-items: center; gap: 10px; }
    
    .status-badge { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-2); }
    
    .status-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--pass);
      animation: breathe 3s ease-in-out infinite;
    }
    
    @keyframes breathe {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }
    
    .status-dot.disconnected { background: var(--fail); animation: none; }
    
    .btn-header {
      background: var(--surface); border: 1px solid var(--border);
      color: var(--text-2); padding: 6px 10px; border-radius: 6px;
      font-family: inherit; font-size: 11px; cursor: pointer;
      display: flex; align-items: center; gap: 5px;
      transition: all 0.25s ease;
    }
    
    .btn-header:hover { border-color: var(--text-3); color: var(--text); }
    
    .main-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    .workflow-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    .workflow-panel {
      background: var(--surface);
      background-image: var(--surface-glow);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      min-height: 600px;
      display: flex; flex-direction: column;
      box-shadow: var(--card-shadow);
      transition: all 0.5s ease;
    }
    
    .workflow-panel.locked { opacity: 0.5; pointer-events: none; }
    
    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-soft);
      display: flex; align-items: center; justify-content: space-between;
    }
    
    .panel-title {
      font-family: 'IBM Plex Serif', Georgia, serif;
      font-size: 14px; font-weight: 500;
      display: flex; align-items: center; gap: 10px;
    }
    
    .step-number {
      background: var(--accent); color: white;
      width: 22px; height: 22px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px; font-weight: 600;
    }
    
    .workflow-panel.locked .step-number { background: var(--text-3); }
    
    .lock-icon { color: var(--text-3); font-size: 10px; display: flex; align-items: center; gap: 5px; }
    
    .panel-body { padding: 16px; flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
    
    .upload-zone {
      border: 1.5px dashed var(--border);
      border-radius: 10px;
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(180deg, var(--bg) 0%, rgba(0,0,0,0.01) 100%);
    }
    
    .upload-zone:hover { border-color: var(--accent); background: var(--accent-soft); }
    .upload-zone svg { color: var(--text-3); margin-bottom: 10px; opacity: 0.7; }
    .upload-zone p { font-size: 13px; color: var(--text); margin-bottom: 4px; }
    .upload-zone small { font-size: 11px; color: var(--text-3); }
    .upload-zone input[type="file"] { display: none; }
    
    .processing-indicator {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px;
      background: var(--accent-soft);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .breath-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--accent);
      animation: breathe 2s ease-in-out infinite;
    }
    
    .processing-indicator span { font-size: 12px; color: var(--text-2); }
    
    .success-indicator {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px;
      background: var(--pass-soft);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 12px;
      color: var(--pass);
      font-size: 12px; font-weight: 500;
    }
    
    .error-indicator {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px;
      background: var(--fail-soft);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 12px;
      color: var(--fail);
      font-size: 12px; font-weight: 500;
    }
    
    /* COMPACT CHECKLIST STYLES */
    .checklist-container {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 12px;
      flex: 1;
      display: flex; flex-direction: column;
      background: var(--surface);
    }
    
    .checklist-header {
      padding: 8px 12px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    
    .checklist-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
    .checklist-count { font-size: 11px; color: var(--text-3); }
    
    .checklist-body { flex: 1; overflow-y: auto; max-height: 480px; }
    
    .category-header {
      padding: 6px 12px;
      background: var(--text);
      color: var(--bg);
      font-size: 10px; font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .checklist-item {
      display: flex; align-items: flex-start; gap: 8px;
      padding: 6px 12px;
      border-bottom: 1px solid var(--border-soft);
      transition: background 0.15s ease;
      font-size: 12px;
    }
    
    .checklist-item:hover { background: var(--bg); }
    .checklist-item.removed { background: var(--fail-soft); opacity: 0.6; }
    .checklist-item.removed .item-text { text-decoration: line-through; }
    
    .item-checkbox input { width: 14px; height: 14px; margin-top: 1px; cursor: pointer; accent-color: var(--accent); }
    .item-content { flex: 1; min-width: 0; }
    .item-id { font-size: 9px; color: var(--text-3); display: inline; margin-right: 6px; }
    .item-text { font-size: 12px; color: var(--text); display: inline; }
    .item-meta { font-size: 10px; color: var(--text-3); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-expected { color: var(--accent); }
    
    /* Compact mode: single line per item */
    .checklist-item.compact {
      padding: 4px 12px;
      align-items: center;
    }
    .checklist-item.compact .item-meta { display: none; }
    
    .action-bar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: auto;
    }
    
    .action-info { font-size: 11px; color: var(--text-3); }
    .action-info strong { color: var(--text); }
    
    .btn {
      padding: 8px 14px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 11px; font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.25s ease;
    }
    
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-success { background: var(--pass); color: white; border-color: var(--pass); }
    .btn-success:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover:not(:disabled) { border-color: var(--text-3); }
    
    /* COMPACT RESULTS STYLES */
    .results-container { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: var(--surface); }
    
    .results-header {
      padding: 10px 12px;
      background: var(--text);
      color: var(--bg);
      display: flex; align-items: center; justify-content: space-between;
    }
    
    .results-title { font-family: 'IBM Plex Serif', Georgia, serif; font-size: 12px; font-weight: 500; }
    
    .results-actions button {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 4px 10px; border-radius: 4px;
      font-family: inherit; font-size: 10px;
      cursor: pointer; margin-left: 6px;
      transition: all 0.2s ease;
    }
    
    .results-actions button:hover { background: rgba(255,255,255,0.2); }
    
    .results-summary-bar {
      display: flex; gap: 12px; padding: 8px 12px;
      background: var(--bg); border-bottom: 1px solid var(--border);
      font-size: 11px;
    }
    
    .results-summary-bar .stat { display: flex; align-items: center; gap: 4px; }
    .results-summary-bar .stat.pass { color: var(--pass); }
    .results-summary-bar .stat.fail { color: var(--fail); }
    .results-summary-bar .stat.gap { color: var(--gap); }
    .results-summary-bar .stat.na { color: var(--text-3); }
    
    .results-body { max-height: 380px; overflow-y: auto; }
    
    .result-item {
      display: flex; align-items: flex-start; gap: 8px;
      padding: 6px 12px;
      border-bottom: 1px solid var(--border-soft);
      font-size: 12px;
    }
    
    .result-status {
      width: 18px; height: 18px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }
    
    .result-status.pass { background: var(--pass-soft); color: var(--pass); }
    .result-status.fail { background: var(--fail-soft); color: var(--fail); }
    .result-status.gap { background: var(--gap-soft); color: var(--gap); }
    .result-status.na { background: var(--gap-soft); color: var(--text-3); }
    
    .result-content { flex: 1; min-width: 0; }
    .result-id { font-size: 9px; color: var(--text-3); display: inline; margin-right: 6px; }
    .result-text { font-size: 12px; color: var(--text); display: inline; }
    .result-finding { font-size: 10px; color: var(--text-2); margin-top: 3px; padding: 4px 8px; background: var(--bg); border-radius: 4px; }
    
    .after-sample-info {
      background: var(--accent-soft);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }
    
    .after-sample-badge { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 500; color: var(--text); }
    .after-sample-meta { font-size: 11px; color: var(--text-2); margin-top: 4px; }
    
    .empty-state {
      flex: 1;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center;
      color: var(--text-3);
      padding: 32px;
    }
    
    .empty-state svg { margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { font-size: 13px; margin-bottom: 4px; color: var(--text-2); }
    .empty-state small { font-size: 11px; opacity: 0.7; }
    
    /* Validation Activity Animation */
    .validation-activity {
      flex: 1;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center;
      padding: 32px;
    }
    
    .activity-icon {
      position: relative;
      width: 56px; height: 56px;
      margin-bottom: 20px;
    }
    
    .activity-spinner {
      position: absolute; inset: 0;
      color: var(--accent);
      animation: spin 2s linear infinite;
    }
    
    .activity-check {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: var(--accent);
      opacity: 0;
      animation: pulse-check 10s ease-in-out infinite;
    }
    
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse-check {
      0%, 90% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      95% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
    }
    
    .activity-step {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 8px;
      min-height: 20px;
      transition: opacity 0.3s ease;
    }
    
    .activity-step.fading { opacity: 0; }
    
    .activity-progress {
      margin-bottom: 12px;
    }
    
    .activity-dots {
      display: flex; gap: 6px; justify-content: center;
    }
    
    .activity-dots .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s ease;
    }
    
    .activity-dots .dot.active {
      background: var(--accent);
      transform: scale(1.2);
    }
    
    .activity-dots .dot.done {
      background: var(--pass);
    }
    
    .activity-sub {
      font-size: 11px;
      color: var(--text-3);
      min-height: 16px;
    }
    
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(61, 56, 48, 0.6);
      backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    
    .modal-overlay.hidden { display: none; }
    
    .modal {
      background: var(--surface);
      background-image: var(--surface-glow);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 340px; padding: 24px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.15);
    }
    
    .modal h2 { font-family: 'IBM Plex Serif', Georgia, serif; font-size: 18px; font-weight: 500; margin-bottom: 6px; }
    .modal p { font-size: 12px; color: var(--text-3); margin-bottom: 18px; }
    
    .modal input {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--border); border-radius: 8px;
      font-family: inherit; font-size: 13px;
      margin-bottom: 10px;
      background: var(--bg); color: var(--text);
      transition: all 0.2s ease;
    }
    
    .modal input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }
    
    .modal button {
      width: 100%; padding: 10px;
      background: var(--text); color: var(--bg);
      border: none; border-radius: 8px;
      font-family: inherit; font-size: 13px; font-weight: 500;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    
    .modal button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .modal button:disabled { background: var(--text-3); cursor: not-allowed; transform: none; box-shadow: none; }
    .modal .error { color: var(--fail); font-size: 11px; margin-top: 10px; text-align: center; }
    
    .source-selector { display: flex; gap: 8px; margin-bottom: 10px; }
    .source-option { flex: 1; cursor: pointer; }
    .source-option input { display: none; }
    
    .source-label {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 12px;
      border: 1px solid var(--border); border-radius: 8px;
      font-size: 12px; color: var(--text-2);
      transition: all 0.25s ease;
      background: var(--surface);
    }
    
    .source-option input:checked + .source-label { border-color: var(--accent); background: var(--accent-soft); color: var(--accent); }
    .source-label:hover { border-color: var(--text-3); }
    
    .input-label { display: block; font-size: 10px; font-weight: 600; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 6px; }
    
    .checklist-dropdown {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--border); border-radius: 8px;
      font-family: inherit; font-size: 12px;
      color: var(--text); background: var(--surface);
      cursor: pointer; transition: all 0.2s ease;
    }
    
    .checklist-dropdown:focus { outline: none; border-color: var(--accent); }
    
    .background-docs { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-size: 11px; }
    .background-docs-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; color: var(--text-2); }
    .background-docs-header span:first-of-type { font-size: 11px; font-weight: 600; color: var(--text); }
    .background-docs-note { font-size: 10px; color: var(--text-3); font-style: italic; }
    .background-docs-list { display: flex; flex-direction: column; gap: 8px; }
    .background-doc-group { padding-left: 18px; }
    .background-doc-group-title { font-size: 10px; font-weight: 600; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 2px; }
    .background-doc-item { font-size: 11px; color: var(--text-2); padding: 2px 0; }
    
    .approved-badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px;
      background: var(--pass-soft);
      color: var(--pass);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 11px; font-weight: 500;
      margin-bottom: 12px;
    }
    
    .mode-toggle {
      position: fixed; bottom: 20px; right: 20px;
      width: 36px; height: 36px; border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      background-image: var(--surface-glow);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.4s ease;
      box-shadow: var(--card-shadow);
      z-index: 100;
    }
    
    .mode-toggle:hover { border-color: var(--text-3); transform: scale(1.08); box-shadow: var(--card-shadow-hover); }
    .mode-toggle svg { width: 16px; height: 16px; color: var(--text-3); transition: all 0.4s ease; }
    .mode-toggle:hover svg { color: var(--text-2); }
    .mode-toggle .sun { display: none; }
    .mode-toggle .moon { display: block; }
    [data-mode="moonlit"] .mode-toggle .sun { display: block; }
    [data-mode="moonlit"] .mode-toggle .moon { display: none; }
    
    .hidden { display: none !important; }
    
    /* Filter tabs for results */
    .filter-tabs {
      display: flex; gap: 2px; padding: 6px 12px; background: var(--bg); border-bottom: 1px solid var(--border);
    }
    .filter-tab {
      padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;
      background: transparent; border: none; color: var(--text-3);
      font-family: inherit; transition: all 0.2s;
    }
    .filter-tab:hover { color: var(--text); }
    .filter-tab.active { background: var(--surface); color: var(--text); font-weight: 500; }
  </style>
</head>
<body>

  <div class="modal-overlay" id="loginModal">
    <div class="modal">
      <h2>QA Demo</h2>
      <p>Enter password to continue</p>
      <input type="password" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter')login()">
      <button id="loginBtn" onclick="login()">Connect</button>
      <div class="error hidden" id="loginError"></div>
    </div>
  </div>

  <header class="header">
    <div class="logo-section">
      <div class="logo">OSG</div>
      <div class="brand-text">
        <div class="brand-name">QA Demo</div>
        <div class="brand-sub">Requirements to Validation</div>
      </div>
    </div>
    <div class="header-actions">
      <div class="status-badge">
        <div class="status-dot disconnected" id="connectionDot"></div>
        <span id="connectionStatus">Disconnected</span>
      </div>
      <button class="btn-header" onclick="resetAll()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        Reset
      </button>
      <button class="btn-header" onclick="logout()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Logout
      </button>
    </div>
  </header>
  
  <div class="main-container">
    <div class="workflow-grid">
      
      <div class="workflow-panel" id="panel1">
        <div class="panel-header">
          <div class="panel-title"><span class="step-number">1</span> Checklist</div>
        </div>
        <div class="panel-body">
          
          <div id="state1-upload">
            <div class="source-selector">
              <label class="source-option">
                <input type="radio" name="checklistSource" value="existing" onchange="toggleChecklistSource('existing')">
                <span class="source-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg> Existing</span>
              </label>
              <label class="source-option">
                <input type="radio" name="checklistSource" value="new" checked onchange="toggleChecklistSource('new')">
                <span class="source-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Upload</span>
              </label>
            </div>
            
            <div id="existingChecklistSection" class="hidden" style="margin-top: 14px;">
              <label class="input-label">Select Checklist</label>
              <select id="checklistDropdown" class="checklist-dropdown" onchange="handleChecklistSelect()">
                <option value="">-- Select a checklist --</option>
              </select>
              <button class="btn btn-primary" style="margin-top: 10px; width: 100%;" onclick="loadSelectedChecklist()" id="loadChecklistBtn" disabled>Load Checklist</button>
            </div>
            
            <div id="newUploadSection" style="margin-top: 14px;">
              <div class="upload-zone" onclick="document.getElementById('requirementsFile').click()">
                <input type="file" id="requirementsFile" accept=".pdf,.docx,.doc,.txt" onchange="handleRequirementsUpload(event)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <p>Drop requirements document</p>
                <small>PDF, DOCX, TXT</small>
              </div>
            </div>
          </div>
          
          <div id="state1-processing" class="hidden">
            <div class="processing-indicator"><div class="breath-dot"></div><span id="processing1Text">Uploading...</span></div>
            <div class="empty-state"><svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>Analyzing requirements</p></div>
          </div>
          
          <div id="state1-review" class="hidden">
            <div class="success-indicator"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span id="extractedFromText">Extracted from document</span></div>
            <div class="checklist-container">
              <div class="checklist-header"><span class="checklist-title">Generated Checklist</span><span class="checklist-count"><span id="itemCount">0</span> items</span></div>
              <div class="checklist-body" id="checklistBody"></div>
            </div>
            <div class="action-bar">
              <div class="action-info" id="changesSummary">Review and approve</div>
              <button class="btn btn-success" onclick="approveChecklist()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Approve</button>
            </div>
          </div>
          
          <div id="state1-approved" class="hidden">
            <div class="success-indicator"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span>Approved â€” Ready for validation</span></div>
            <div class="checklist-container" style="opacity: 0.85;">
              <div class="checklist-header"><span class="checklist-title">Approved Checklist</span><span class="checklist-count" id="approvedItemCount">0 items</span></div>
              <div class="checklist-body" id="approvedChecklistBody"></div>
            </div>
            <div class="action-bar"><div class="action-info">Locked for validation</div><button class="btn btn-secondary" onclick="editChecklist()">Edit</button></div>
          </div>
          
          <div id="state1-error" class="hidden">
            <div class="error-indicator"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span id="error1Text">An error occurred</span></div>
            <button class="btn btn-secondary" onclick="resetPart1()">Try Again</button>
          </div>
          
        </div>
      </div>
      
      <div class="workflow-panel locked" id="panel2">
        <div class="panel-header">
          <div class="panel-title"><span class="step-number">2</span> Validation</div>
          <div class="lock-icon" id="lockIcon"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Approve to unlock</div>
        </div>
        <div class="panel-body">
          
          <div id="state2-locked">
            <div class="empty-state"><svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><p>Validation Locked</p><small>Complete Part 1 to proceed</small></div>
          </div>
          
          <div id="state2-upload" class="hidden">
            <div class="approved-badge"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span id="approvedBadgeText">Checklist Approved</span></div>
            <div class="upload-zone" onclick="document.getElementById('afterSampleFile').click()" style="margin-bottom: 16px;">
              <input type="file" id="afterSampleFile" accept=".pdf" onchange="handleAfterSampleUpload(event)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              <p>Drop After Sample PDF</p>
              <small>Document to validate</small>
            </div>
            <div class="background-docs">
              <div class="background-docs-header"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg><span>Reference Collections</span><span class="background-docs-note">(auto)</span></div>
              <div class="background-docs-list">
                <div class="background-doc-group"><div class="background-doc-group-title">Templates</div><div class="background-doc-item">Letter templates</div></div>
                <div class="background-doc-group"><div class="background-doc-group-title">Disclosures</div><div class="background-doc-item">Fee schedules, state disclosures</div></div>
              </div>
            </div>
          </div>
          
          <div id="state2-processing" class="hidden">
            <div class="processing-indicator"><div class="breath-dot"></div><span id="processing2Text">Uploading...</span></div>
            <div class="validation-activity">
              <div class="activity-icon">
                <svg class="activity-spinner" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10" stroke-dasharray="31.4" stroke-dashoffset="10"/>
                </svg>
                <svg class="activity-check" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              <p class="activity-step" id="activityStep">Analyzing document structure</p>
              <div class="activity-progress">
                <div class="activity-dots">
                  <span class="dot active"></span>
                  <span class="dot"></span>
                  <span class="dot"></span>
                  <span class="dot"></span>
                  <span class="dot"></span>
                </div>
              </div>
              <p class="activity-sub" id="activitySub">Reading After Sample PDF...</p>
            </div>
          </div>
          
          <div id="state2-results" class="hidden">
            <div class="after-sample-info">
              <div class="after-sample-badge"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg><span id="afterSampleName">After Sample</span></div>
              <div class="after-sample-meta" id="afterSampleMeta">Validated</div>
            </div>
            <div class="results-container">
              <div class="results-header"><span class="results-title">Validation Results</span><div class="results-actions"><button onclick="downloadResults()">Export</button><button onclick="rerunValidation()">Rerun</button></div></div>
              <div class="results-summary-bar">
                <div class="stat pass"><strong id="passCount">0</strong> pass</div>
                <div class="stat fail"><strong id="failCount">0</strong> fail</div>
                <div class="stat gap"><strong id="gapCount">0</strong> gap</div>
                <div class="stat na"><strong id="naCount">0</strong> n/a</div>
              </div>
              <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterResults('all')">All</button>
                <button class="filter-tab" onclick="filterResults('pass')">Pass</button>
                <button class="filter-tab" onclick="filterResults('fail')">Fail</button>
                <button class="filter-tab" onclick="filterResults('gap')">Gap</button>
                <button class="filter-tab" onclick="filterResults('na')">N/A</button>
              </div>
              <div class="results-body" id="resultsBody"></div>
            </div>
          </div>
          
          <div id="state2-error" class="hidden">
            <div class="error-indicator"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span id="error2Text">An error occurred</span></div>
            <button class="btn btn-secondary" onclick="resetPart2()">Try Again</button>
          </div>
          
        </div>
      </div>
      
    </div>
  </div>
  
  <button class="mode-toggle" onclick="toggleMode()" title="Toggle moonlit mode">
    <svg class="moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
    <svg class="sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
  </button>

  <script>
    const API_BASE = 'https://api.vertesia.io/api/v1';
    const STS_BASE = 'https://api.vertesia.io';
    const ENVIRONMENT_ID = '681915c6a01fb262a410c161';
    const PASSWORD = 'OSG2026Demo';
    const API_KEY = 'sk-25bf067b64952c430f0b786b52bf89f8';
    const AGENT_CHECKLIST_GENERATION = 'QAChecklistGeneration';
    const AGENT_CHECKLIST_VALIDATION = 'QAChecklistValidation';
    const MODEL = 'publishers/anthropic/models/claude-opus-4-5';
    
    let jwt = null, requirementsDocId = null, checklistDocId = null, afterSampleDocId = null;
    let checklistData = [], validationResults = null, currentChecklistName = '', currentFilter = 'all';
    let validationStepInterval = null;
    
    const VALIDATION_STEPS = [
      { step: 'Analyzing document structure', sub: 'Reading After Sample PDF...' },
      { step: 'Extracting consumer data', sub: 'Loan number, name, address...' },
      { step: 'Verifying client data', sub: 'Matching against spreadsheet...' },
      { step: 'Checking branding elements', sub: 'Logo placement, return address...' },
      { step: 'Validating document flow', sub: 'Page sequence, templates...' },
      { step: 'Reviewing state disclosures', sub: 'Checking required verbiage...' },
      { step: 'Verifying fee schedule', sub: 'State-specific requirements...' },
      { step: 'Checking data integrity', sub: 'Loan truncation, leading zeros...' },
      { step: 'Validating formatting rules', sub: 'Paragraph splits, date formatting...' },
      { step: 'Generating QA report', sub: 'Compiling findings...' }
    ];
    
    function startValidationSteps() {
      let stepIndex = 0;
      const stepEl = document.getElementById('activityStep');
      const subEl = document.getElementById('activitySub');
      const dots = document.querySelectorAll('.activity-dots .dot');
      
      function updateStep() {
        // Fade out
        stepEl.classList.add('fading');
        
        setTimeout(() => {
          // Update content
          const step = VALIDATION_STEPS[stepIndex];
          stepEl.textContent = step.step;
          subEl.textContent = step.sub;
          
          // Update dots
          dots.forEach((dot, i) => {
            dot.classList.remove('active', 'done');
            const dotStep = Math.floor(i * VALIDATION_STEPS.length / dots.length);
            if (stepIndex > dotStep) dot.classList.add('done');
            else if (Math.floor(stepIndex * dots.length / VALIDATION_STEPS.length) === i) dot.classList.add('active');
          });
          
          // Fade in
          stepEl.classList.remove('fading');
          
          // Next step
          stepIndex = (stepIndex + 1) % VALIDATION_STEPS.length;
        }, 300);
      }
      
      updateStep();
      validationStepInterval = setInterval(updateStep, 8000);
    }
    
    function stopValidationSteps() {
      if (validationStepInterval) {
        clearInterval(validationStepInterval);
        validationStepInterval = null;
      }
    }
    
    function toggleMode() {
      const html = document.documentElement;
      if (html.getAttribute('data-mode') === 'moonlit') { html.removeAttribute('data-mode'); localStorage.removeItem('osg_mode'); }
      else { html.setAttribute('data-mode', 'moonlit'); localStorage.setItem('osg_mode', 'moonlit'); }
    }
    
    async function login() {
      const password = document.getElementById('passwordInput').value.trim();
      const loginBtn = document.getElementById('loginBtn');
      if (password !== PASSWORD) { showLoginError('Incorrect password'); return; }
      loginBtn.disabled = true; loginBtn.textContent = 'Connecting...';
      document.getElementById('loginError').classList.add('hidden');
      try {
        const response = await fetch(`${STS_BASE}/auth/token`, { method: 'GET', headers: { 'Authorization': `Bearer ${API_KEY}` } });
        if (!response.ok) throw new Error('Failed to authenticate');
        const data = await response.json(); jwt = data.token;
        sessionStorage.setItem('osg_qa_jwt', jwt); sessionStorage.setItem('osg_qa_authenticated', 'true');
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('connectionDot').classList.remove('disconnected');
        document.getElementById('connectionStatus').textContent = 'Connected';
      } catch (error) { showLoginError('Authentication failed'); loginBtn.disabled = false; loginBtn.textContent = 'Connect'; }
    }
    
    function logout() { jwt = null; sessionStorage.removeItem('osg_qa_jwt'); sessionStorage.removeItem('osg_qa_authenticated'); document.getElementById('loginModal').classList.remove('hidden'); document.getElementById('connectionDot').classList.add('disconnected'); document.getElementById('connectionStatus').textContent = 'Disconnected'; resetAll(); }
    function showLoginError(msg) { const el = document.getElementById('loginError'); el.textContent = msg; el.classList.remove('hidden'); }
    
    async function checkAuth() {
      if (sessionStorage.getItem('osg_qa_authenticated') === 'true' && sessionStorage.getItem('osg_qa_jwt')) {
        jwt = sessionStorage.getItem('osg_qa_jwt');
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('connectionDot').classList.remove('disconnected');
        document.getElementById('connectionStatus').textContent = 'Connected';
      }
    }
    
    async function apiCall(endpoint, options = {}) {
      const response = await fetch(`${API_BASE}${endpoint}`, { ...options, headers: { 'Authorization': `Bearer ${jwt}`, 'Content-Type': 'application/json', ...options.headers } });
      if (!response.ok) { const text = await response.text(); if (text.includes('exp') || text.includes('timestamp') || text.includes('<!DOCTYPE')) { logout(); throw new Error('Session expired. Please login again.'); } throw new Error(text || `API error: ${response.status}`); }
      return response.json();
    }
    
    async function uploadFile(file) {
      let mimeType = file.type || ({ pdf: 'application/pdf', docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', doc: 'application/msword', txt: 'text/plain' }[file.name.split('.').pop().toLowerCase()] || 'application/octet-stream');
      const uploadUrlRes = await apiCall('/objects/upload-url', { method: 'POST', body: JSON.stringify({ name: file.name, mime_type: mimeType }) });
      await fetch(uploadUrlRes.url, { method: 'PUT', body: file, headers: { 'Content-Type': mimeType } });
      const objectRes = await apiCall('/objects', { method: 'POST', body: JSON.stringify({ name: file.name, content: { source: uploadUrlRes.id, type: mimeType, name: file.name } }) });
      return objectRes.id;
    }
    
    async function runAgent(interactionName, data) { return await apiCall('/execute/async', { method: 'POST', body: JSON.stringify({ type: 'conversation', interaction: interactionName, data, config: { environment: ENVIRONMENT_ID, model: MODEL }, interactive: true, max_iterations: 100 }) }); }
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    
    function toggleChecklistSource(source) { document.getElementById('existingChecklistSection').classList.toggle('hidden', source !== 'existing'); document.getElementById('newUploadSection').classList.toggle('hidden', source !== 'new'); if (source === 'existing') loadExistingChecklists(); }
    
    async function loadExistingChecklists() {
      const dropdown = document.getElementById('checklistDropdown'); dropdown.innerHTML = '<option value="">Loading...</option>';
      try {
        const docs = await apiCall('/objects?limit=100&offset=0'); const docList = Array.isArray(docs) ? docs : docs?.objects || [];
        const checklists = docList.filter(d => d.name?.toLowerCase().includes('checklist') && !d.name?.toLowerCase().includes('validation'));
        dropdown.innerHTML = '<option value="">-- Select a checklist --</option>';
        checklists.forEach(doc => { const opt = document.createElement('option'); opt.value = doc.id; opt.textContent = doc.name; opt.dataset.source = doc.content?.source || ''; dropdown.appendChild(opt); });
        if (checklists.length === 0) dropdown.innerHTML = '<option value="">No checklists found</option>';
      } catch (e) { dropdown.innerHTML = '<option value="">Error loading</option>'; }
    }
    
    function handleChecklistSelect() { document.getElementById('loadChecklistBtn').disabled = !document.getElementById('checklistDropdown').value; }
    
    async function loadSelectedChecklist() {
      const dropdown = document.getElementById('checklistDropdown'); const opt = dropdown.options[dropdown.selectedIndex]; if (!dropdown.value) return;
      showState1('processing'); document.getElementById('processing1Text').textContent = 'Loading checklist...';
      try {
        checklistDocId = dropdown.value; const content = await fetchDocumentContent(opt.dataset.source); checklistData = parseChecklist(content);
        renderChecklist(checklistData, 'checklistBody'); document.getElementById('itemCount').textContent = checklistData.length;
        document.getElementById('extractedFromText').textContent = `Loaded: ${opt.textContent}`; currentChecklistName = opt.textContent; showState1('review');
      } catch (e) { document.getElementById('error1Text').textContent = e.message; showState1('error'); }
    }
    
    async function handleRequirementsUpload(event) {
      const file = event.target.files[0]; if (!file) return;
      showState1('processing'); document.getElementById('processing1Text').textContent = 'Uploading...';
      try {
        requirementsDocId = await uploadFile(file); document.getElementById('processing1Text').textContent = 'Starting extraction...';
        await runAgent(AGENT_CHECKLIST_GENERATION, { task: requirementsDocId });
        // Extract job codes - try multiple patterns
        const jobCodeMatch = file.name.match(/\(([^)]+)\)/); 
        const jobNumMatch = file.name.match(/#?(\d{4})/);
        const jobCode = jobCodeMatch ? jobCodeMatch[1] : null;
        const jobNum = jobNumMatch ? jobNumMatch[1] : null;
        
        let checklistDoc = null, attempts = 0;
        while (!checklistDoc) {
          await sleep(3000); attempts++; document.getElementById('processing1Text').textContent = `Waiting for checklist... (${attempts * 3}s)`;
          try { 
            const docs = await apiCall('/objects?limit=50&offset=0'); 
            const docList = Array.isArray(docs) ? docs : docs?.objects || [];
            const tenMinAgo = Date.now() - 10 * 60 * 1000;
            // More flexible matching - look for "checklist" and either job code OR job number
            checklistDoc = docList.find(d => {
              const created = new Date(d.created_at).getTime();
              const isRecent = created > tenMinAgo;
              const isChecklist = d.name?.toLowerCase().includes('checklist') && !d.name?.toLowerCase().includes('validation');
              const matchesJob = !jobCode && !jobNum ? true : 
                (jobCode && d.name?.includes(jobCode)) || 
                (jobNum && d.name?.includes(jobNum)) ||
                (jobNum && d.name?.includes(`#${jobNum}`));
              return isRecent && isChecklist && matchesJob;
            });
            console.log(`Checklist poll ${attempts}: Found ${docList.length} docs, match:`, checklistDoc?.name);
          } catch (e) { console.log('Poll error:', e); }
        }
        checklistDocId = checklistDoc.id; currentChecklistName = checklistDoc.name;
        document.getElementById('processing1Text').textContent = 'Loading content...';
        const content = await fetchDocumentContent(checklistDoc.content?.source); checklistData = parseChecklist(content);
        renderChecklist(checklistData, 'checklistBody'); document.getElementById('itemCount').textContent = checklistData.length;
        document.getElementById('extractedFromText').textContent = `Extracted from ${file.name}`; showState1('review');
      } catch (e) { document.getElementById('error1Text').textContent = e.message; showState1('error'); }
    }
    
    async function fetchDocumentContent(source) { if (!source) throw new Error('No source'); const { url } = await apiCall('/objects/download-url', { method: 'POST', body: JSON.stringify({ file: source, format: 'original' }) }); return await (await fetch(url)).text(); }
    
    function parseChecklist(content) {
      const items = [], lines = (typeof content === 'string' ? content : JSON.stringify(content)).split('\n'); let currentCategory = 'GENERAL', idCounter = 1;
      for (const line of lines) { if (line.startsWith('### ')) { currentCategory = line.replace('### ', '').trim().toUpperCase(); continue; }
        if (line.startsWith('|') && !line.includes('---') && !line.toLowerCase().includes('| id')) { const cells = line.split('|').map(c => c.trim()).filter(c => c);
          if (cells.length >= 2) items.push({ id: cells[0] || idCounter++, assertion: cells[1] || '', expected: cells[2] || '', appliesTo: cells[3] || 'ALL', category: currentCategory, checked: true }); } }
      return items.length ? items : [{ id: '-', assertion: 'No items found - check format', expected: '', appliesTo: '', category: 'ERROR', checked: false }];
    }
    
    function renderChecklist(items, containerId) {
      const container = document.getElementById(containerId); container.innerHTML = ''; let currentCategory = null;
      for (const item of items) { if (item.category !== currentCategory) { currentCategory = item.category; const h = document.createElement('div'); h.className = 'category-header'; h.textContent = currentCategory; container.appendChild(h); }
        const el = document.createElement('div'); el.className = 'checklist-item' + (item.checked ? '' : ' removed');
        el.innerHTML = `<div class="item-checkbox"><input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleItem('${item.id}')"></div><div class="item-content"><span class="item-id">${item.id}</span><span class="item-text">${item.assertion}</span><div class="item-meta"><span class="item-expected">${item.expected}</span> Â· ${item.appliesTo}</div></div>`;
        container.appendChild(el); }
    }
    
    function toggleItem(id) { const item = checklistData.find(i => i.id == id); if (item) { item.checked = !item.checked; renderChecklist(checklistData, 'checklistBody'); updateChangesSummary(); } }
    function updateChangesSummary() { const removed = checklistData.filter(i => !i.checked).length; document.getElementById('changesSummary').innerHTML = removed > 0 ? `<strong>${removed} removed</strong>` : 'Review and approve'; }
    
    function approveChecklist() { const approved = checklistData.filter(i => i.checked); renderChecklistReadOnly(approved, 'approvedChecklistBody'); document.getElementById('approvedItemCount').textContent = `${approved.length} items`; document.getElementById('approvedBadgeText').textContent = `Approved (${approved.length} items)`; showState1('approved'); unlockPart2(); }
    
    function renderChecklistReadOnly(items, containerId) {
      const container = document.getElementById(containerId); container.innerHTML = ''; let currentCategory = null;
      for (const item of items) { if (item.category !== currentCategory) { currentCategory = item.category; const h = document.createElement('div'); h.className = 'category-header'; h.textContent = currentCategory; container.appendChild(h); }
        const el = document.createElement('div'); el.className = 'checklist-item'; el.style.pointerEvents = 'none';
        el.innerHTML = `<div class="item-content"><span class="item-id">${item.id}</span><span class="item-text">${item.assertion}</span><div class="item-meta"><span class="item-expected">${item.expected}</span> Â· ${item.appliesTo}</div></div>`;
        container.appendChild(el); }
    }
    
    function editChecklist() { showState1('review'); lockPart2(); }
    function unlockPart2() { document.getElementById('panel2').classList.remove('locked'); document.getElementById('lockIcon').classList.add('hidden'); showState2('upload'); }
    function lockPart2() { document.getElementById('panel2').classList.add('locked'); document.getElementById('lockIcon').classList.remove('hidden'); showState2('locked'); }
    
    async function handleAfterSampleUpload(event) {
      const file = event.target.files[0]; if (!file) return;
      showState2('processing'); document.getElementById('processing2Text').textContent = 'Uploading...';
      try {
        afterSampleDocId = await uploadFile(file); document.getElementById('processing2Text').textContent = 'Starting validation...';
        startValidationSteps();
        const jobCodeMatch = currentChecklistName?.match(/(US\d+|\d{4})/i); const jobCode = jobCodeMatch ? jobCodeMatch[1] : null;
        await runAgent(AGENT_CHECKLIST_VALIDATION, { after_sample: afterSampleDocId, checklist_id: checklistDocId });
        let validationDoc = null, attempts = 0;
        // Keep polling until we find the validation document - no timeout
        while (!validationDoc) {
          await sleep(3000); attempts++; document.getElementById('processing2Text').textContent = `Validating... (${attempts * 3}s)`;
          try { 
            const docs = await apiCall('/objects?limit=100&offset=0'); 
            const docList = Array.isArray(docs) ? docs : docs?.objects || [];
            const fifteenMinAgo = Date.now() - 15 * 60 * 1000;
            // More flexible matching - look for "validation" in name
            validationDoc = docList.find(d => {
              const created = new Date(d.created_at).getTime();
              const nameMatch = d.name?.toLowerCase().includes('validation');
              const isRecent = created > fifteenMinAgo;
              const hasJobCode = !jobCode || d.name?.includes(jobCode);
              return isRecent && nameMatch && hasJobCode;
            });
            // Also try matching by "QA" if validation not found
            if (!validationDoc) {
              validationDoc = docList.find(d => {
                const created = new Date(d.created_at).getTime();
                const nameMatch = d.name?.toLowerCase().includes('qa') && d.name?.toLowerCase().includes('report');
                const isRecent = created > fifteenMinAgo;
                return isRecent && nameMatch;
              });
            }
            console.log(`Poll ${attempts}: Found ${docList.length} docs, validation doc:`, validationDoc?.name);
          } catch (e) { console.log('Poll error:', e); }
        }
        document.getElementById('processing2Text').textContent = 'Loading results...';
        const content = await fetchDocumentContent(validationDoc.content?.source); 
        validationResults = parseValidationResults(content);
        const nameParts = validationDoc.name?.split(' - ') || [];
        document.getElementById('afterSampleName').textContent = validationResults.consumerName !== 'Unknown' ? `${validationResults.consumerName} - ${validationResults.loanNumber}` : (nameParts.slice(2).join(' - ') || 'Unknown');
        document.getElementById('afterSampleMeta').textContent = `State: ${validationResults.state || 'Unknown'} | Type: ${validationResults.type || 'Unknown'} | Client: ${validationResults.clientName || 'Unknown'}`;
        renderResults(validationResults.items); updateResultsSummary(validationResults.items); stopValidationSteps(); showState2('results');
      } catch (e) { stopValidationSteps(); document.getElementById('error2Text').textContent = e.message; showState2('error'); }
    }
    
    function parseValidationResults(content) {
      const results = { state: 'Unknown', type: 'Unknown', clientName: 'Unknown', consumerName: 'Unknown', loanNumber: 'Unknown', items: [] };
      const lines = (typeof content === 'string' ? content : JSON.stringify(content)).split('\n');
      for (const line of lines) {
        if (line.includes('|') && !line.includes('---')) { const cells = line.split('|').map(c => c.replace(/\*\*/g, '').trim()).filter(c => c);
          if (cells.length === 2) { 
            const f = cells[0].toLowerCase(); 
            if (f === 'state' || f.includes('state')) { const m = cells[1].match(/([A-Z]{2})/); if (m) results.state = m[1]; }
            if (f === 'letter type' || f === 'type') results.type = cells[1]; 
            if (f === 'client') results.clientName = cells[1];
            if (f === 'consumer') results.consumerName = cells[1];
            if (f === 'loan number' || f === 'loan') { const m = cells[1].match(/(\d{5,})/); if (m) results.loanNumber = m[1]; } 
          } 
        }
        if (line.includes('|--') || line.includes('|-') || line.match(/\|\s*ID\s*\|/i)) continue;
        if (line.startsWith('|') && line.includes('|')) { const cells = line.split('|').map(c => c.replace(/\*\*/g, '').trim()).filter(c => c);
          if (cells.length >= 4) { let ri = -1, fi = -1;
            for (let i = 2; i < cells.length; i++) { const u = cells[i].toUpperCase(); if (u.includes('PASS') || u.includes('FAIL') || u.includes('GAP') || u === 'NA' || u === 'N/A') { ri = i; fi = i + 1; break; } }
            if (ri > 0) { const rt = (cells[ri] || '').toUpperCase(); let rv = 'gap'; if (rt.includes('PASS')) rv = 'pass'; else if (rt.includes('FAIL')) rv = 'fail'; else if (rt === 'NA' || rt === 'N/A') rv = 'na';
              results.items.push({ id: cells[0], assertion: cells[1], result: rv, finding: cells[fi] || '' }); } } } }
      return results.items.length ? results : { ...results, items: [{ id: '-', assertion: 'Parsing error or in progress', result: 'gap', finding: 'Check Vertesia' }] };
    }
    
    function renderResults(items, filter = 'all') {
      const container = document.getElementById('resultsBody'); container.innerHTML = '';
      const filtered = filter === 'all' ? items : items.filter(i => i.result === filter);
      for (const item of filtered) { const el = document.createElement('div'); el.className = 'result-item';
        let icon = item.result === 'pass' ? '<polyline points="20 6 9 17 4 12"/>' : item.result === 'fail' ? '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>' : item.result === 'na' ? '<line x1="5" y1="12" x2="19" y2="12"/>' : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>';
        el.innerHTML = `<div class="result-status ${item.result}"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">${icon}</svg></div><div class="result-content"><span class="result-id">${item.id}</span><span class="result-text">${item.assertion}</span>${item.finding ? `<div class="result-finding">${item.finding}</div>` : ''}</div>`;
        container.appendChild(el); }
    }
    
    function filterResults(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.filter-tab[onclick="filterResults('${filter}')"]`).classList.add('active');
      renderResults(validationResults.items, filter);
    }
    
    function updateResultsSummary(items) { 
      const p = items.filter(i => i.result === 'pass').length;
      const f = items.filter(i => i.result === 'fail').length;
      const g = items.filter(i => i.result === 'gap').length;
      const n = items.filter(i => i.result === 'na').length;
      document.getElementById('passCount').textContent = p;
      document.getElementById('failCount').textContent = f;
      document.getElementById('gapCount').textContent = g;
      document.getElementById('naCount').textContent = n;
    }
    
    function rerunValidation() { showState2('upload'); document.getElementById('afterSampleFile').value = ''; }
    function downloadResults() { let r = `# Validation Results\n\n**${document.getElementById('afterSampleName').textContent}**\n**${document.getElementById('afterSampleMeta').textContent}**\n\n| ID | Assertion | Result | Finding |\n|----|-----------|--------|----------|\n`;
      for (const item of validationResults.items) r += `| ${item.id} | ${item.assertion} | ${item.result.toUpperCase()} | ${item.finding} |\n`;
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([r], { type: 'text/markdown' })); a.download = 'validation-results.md'; a.click(); }
    
    function showState1(state) { ['upload', 'processing', 'review', 'approved', 'error'].forEach(s => document.getElementById(`state1-${s}`).classList.toggle('hidden', s !== state)); }
    function showState2(state) { ['locked', 'upload', 'processing', 'results', 'error'].forEach(s => document.getElementById(`state2-${s}`).classList.toggle('hidden', s !== state)); }
    function resetPart1() { requirementsDocId = null; checklistDocId = null; checklistData = []; document.getElementById('requirementsFile').value = ''; showState1('upload'); lockPart2(); }
    function resetPart2() { afterSampleDocId = null; validationResults = null; document.getElementById('afterSampleFile').value = ''; showState2('upload'); }
    function resetAll() { resetPart1(); resetPart2(); }
    
    if (localStorage.getItem('osg_mode') === 'moonlit') document.documentElement.setAttribute('data-mode', 'moonlit');
    checkAuth();
  </script>

</body>
</html>
